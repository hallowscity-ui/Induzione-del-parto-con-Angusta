<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Induzione del parto</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { margin:0; font-family: Arial; display:flex; height:100vh; }
#sidebar { width:260px; background:#2c3e50; color:white; padding:15px; overflow-y:auto; }
#sidebar h2 { margin-top:0; }
#sidebar input, #sidebar button { width:100%; margin-bottom:8px; padding:6px; }
#sidebar ul { list-style:none; padding:0; }
#sidebar li { padding:8px; background:#34495e; margin-bottom:5px; border-radius:4px; display:flex; justify-content:space-between; }
#sidebar li span { cursor:pointer; flex:1; }
#sidebar li.active { background:#16a085; }
#main { flex:1; padding:15px; background:#ecf0f1; overflow-y:auto; }
table { width:100%; border-collapse:collapse; background:white; }
th, td { border:1px solid #ccc; padding:6px; text-align:center; }
th { background:#eee; }
button { padding:4px 8px; }
.locked { color:#999; font-style:italic; }
</style>
</head>

<body>

<div id="sidebar">
  <h2>Pazienti</h2>
  <input id="nomePaziente" placeholder="Nome paziente">
  <input type="time" id="primaDose">
  <button onclick="aggiungiPaziente()">Aggiungi</button>
  <ul id="listaPazienti"></ul>
</div>

<div id="main">
  <h2 id="titoloPaziente">Seleziona un paziente</h2>
  <div id="scheda"></div>
</div>

<script>
let pazienti = [];
let pazienteSelezionato = null;

function formatta(d){
  return d.toLocaleTimeString("it-IT",{hour:"2-digit",minute:"2-digit"});
}

/* ------------------ CREAZIONE PAZIENTE ------------------ */
function aggiungiPaziente(){
  const nome = nomePaziente.value.trim();
  const ora = primaDose.value;
  if(!nome || !ora) return alert("Nome e orario obbligatori");

  const [h,m] = ora.split(":").map(Number);
  let base = new Date(); base.setHours(h,m,0,0);

  const eventi = [];
  for(let d=0; d<4; d++){
    const som = new Date(base.getTime() + d*4*60*60*1000);
    eventi.push({ tipo:"inizio", dose:d, previsto:new Date(som-30*60000), reale:null, notificato:false });
    eventi.push({ tipo:"somministrazione", dose:d, previsto:new Date(som), reale:null, notificato:false });
    eventi.push({ tipo:"fine", dose:d, previsto:new Date(som+60*60000), reale:null, notificato:false });
  }

  pazienti.push({ nome, eventi });
  salva();
  seleziona(pazienti.length-1);
}

/* ------------------ UI ------------------ */
function seleziona(i){
  pazienteSelezionato=i;
  aggiornaSidebar();
  mostraScheda();
}

function aggiornaSidebar(){
  listaPazienti.innerHTML="";
  pazienti.forEach((p,i)=>{
    const li=document.createElement("li");
    if(i===pazienteSelezionato) li.classList.add("active");
    li.innerHTML=`<span>${p.nome}</span><button onclick="elimina(${i})">✕</button>`;
    li.querySelector("span").onclick=()=>seleziona(i);
    listaPazienti.appendChild(li);
  });
}

function mostraScheda(){
  if(pazienteSelezionato===null) return;
  const p = pazienti[pazienteSelezionato];
  titoloPaziente.textContent=p.nome;
  scheda.innerHTML="";

  const t=document.createElement("table");
  t.innerHTML="<tr><th>Dose</th><th>Evento</th><th>Previsto</th><th>Reale</th><th></th></tr>";
  p.eventi.forEach((e,i)=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${e.dose+1}</td>
      <td>${label(e.tipo)}</td>
      <td>${formatta(e.previsto)}</td>
      <td>${e.reale?formatta(e.reale):"—"}</td>
      <td>
        ${puoRegistrare(e,i)?`<button onclick="registra(${i})">Registra</button>`:
        `<span class="locked">bloccato</span>`}
      </td>`;
    t.appendChild(tr);
  });
  scheda.appendChild(t);
}

/* ------------------ BLOCCO ANTI-ERRORI ------------------ */
function puoRegistrare(e,i){
  const ev = pazienti[pazienteSelezionato].eventi;
  if(e.tipo==="inizio") return true;
  if(e.tipo==="somministrazione") return ev[i-1].reale!==null;
  if(e.tipo==="fine") return ev[i-1].reale!==null;
}

/* ------------------ REGISTRA EVENTO ------------------ */
function registra(i){
  const p=pazienti[pazienteSelezionato];
  const e=p.eventi[i];
  e.reale=new Date();

  if(e.tipo==="inizio"){
    const nuovaSom = new Date(e.reale.getTime()+30*60000);
    ricalcolaDaDose(e.dose, nuovaSom);
  }

  if(e.tipo==="somministrazione"){
    ricalcolaDaDose(e.dose, e.reale);
  }

  salva();
  mostraScheda();
}

/* ------------------ RICALCOLO A DOSE (CORE CLINICO) ------------------ */
function ricalcolaDaDose(doseIndex, nuovaSom){
  const ev=pazienti[pazienteSelezionato].eventi;

  for(let d=doseIndex; d<4; d++){
    const base = new Date(nuovaSom.getTime()+(d-doseIndex)*4*60*60*1000);
    ev[d*3].previsto = new Date(base-30*60000);
    ev[d*3+1].previsto = new Date(base);
    ev[d*3+2].previsto = new Date(base+60*60000);
    ev[d*3].notificato=false;
    ev[d*3+1].notificato=false;
    ev[d*3+2].notificato=false;
  }
}

/* ------------------ NOTIFICHE ROBUSTE ------------------ */
function controlloNotifiche(){
  if(!("Notification"in window)) return;
  const now=new Date();
  pazienti.forEach(p=>{
    p.eventi.forEach(e=>{
      if(!e.notificato && now>=e.previsto){
        Notification.requestPermission().then(perm=>{
          if(perm==="granted"){
            new Notification(`${label(e.tipo)} – ${p.nome}`);
          }
        });
        e.notificato=true;
        salva();
      }
    });
  });
}

/* ------------------ UTIL ------------------ */
function label(t){
  return t==="inizio"?"Inizio tracciato":
         t==="somministrazione"?"Somministrazione":
         "Fine tracciato";
}
function elimina(i){
  if(confirm("Eliminare paziente?")){
    pazienti.splice(i,1);
    pazienteSelezionato=null;
    salva();
    aggiornaSidebar();
    scheda.innerHTML="";
    titoloPaziente.textContent="Seleziona un paziente";
  }
}
function salva(){ localStorage.setItem("induzione",JSON.stringify(pazienti)); }
function carica(){
  const d=localStorage.getItem("induzione");
  if(d){
    pazienti=JSON.parse(d);
    pazienti.forEach(p=>p.eventi.forEach(e=>{
      e.previsto=new Date(e.previsto);
      if(e.reale) e.reale=new Date(e.reale);
    }));
    aggiornaSidebar();
  }
  Notification.requestPermission();
  controlloNotifiche();
}
setInterval(controlloNotifiche,60000);
window.onload=carica;
</script>

</body>
</html>
